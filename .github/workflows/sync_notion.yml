name: Sync GitHub Issues to Notion (IOS)

on:
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened]

jobs:
  sync_issue:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Convert Issue Body to JSON
        run: echo '${{ github.event.issue.body }}' | jq -Rs '.' > issue_body.json

      - name: Send Issue to Notion
        run: |
          ISSUE_BODY=$(cat issue_body.json)

          jq -n \
          --arg database_id "${{ secrets.NOTION_DATABASE_ID }}" \
          --arg title "${{ github.event.issue.title }}" \
          --arg url "${{ github.event.issue.html_url }}" \
          --arg status "ì‘ì—… ì¤‘" \
          --arg team "IOS" \
          --arg assignee "${{ github.event.issue.user.login }}" \
          --arg issue_number "${{ github.event.issue.number }}" \
          '{
            parent: { database_id: $database_id },
            properties: {
              "ì œëª©": { title: [{ text: { content: $title } }] },
              "URL": { url: $url },
              "ìƒíƒœ": { status: { name: $status } },
              "íŒ€": { select: { name: $team } },
              "ë‹´ë‹¹ì": { rich_text: [{ type: "text", text: { content: $assignee } }] },
              "ì´ìŠˆ ë²ˆí˜¸": { number: ($issue_number | tonumber) }
            }
          }' | curl -X POST "https://api.notion.com/v1/pages" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data @-

  update_issue:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Find Notion Page for the Issue
        run: |
          QUERY_RESULT=$(curl -X POST "https://api.notion.com/v1/databases/${{ secrets.NOTION_DATABASE_ID }}/query" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data '{
            "filter": {
              "property": "ì´ìŠˆ ë²ˆí˜¸",
              "number": {
                "equals": ${{ github.event.issue.number }}
              }
            }
          }')

          page_id=$(echo "$QUERY_RESULT" | jq -r '.results[0].id')

          if [[ "$page_id" != "null" && "$page_id" != "" ]]; then
            echo "âœ… Notion Page ID ì°¾ìŒ: $page_id"
            echo "PAGE_ID=$page_id" >> $GITHUB_ENV
          else
            echo "âŒ Notion í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: Update Notion Page Status to "ì™„ë£Œ"
        run: |
          curl -X PATCH "https://api.notion.com/v1/pages/${{ env.PAGE_ID }}" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data '{
            "properties": {
              "ìƒíƒœ": { "status": { "name": "ì™„ë£Œ" } }
            }
          }'

  update_issue_status_for_pr:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Extract Issue Number for PRs
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"

          # âœ… Markdown ë§í¬ì—ì„œ "#ìˆ«ì" íŒ¨í„´ì„ ì°¾ì•„ ìˆ«ìë§Œ ì¶”ì¶œ
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | sed 's/#//g' | tail -n 1)

          if [[ -z "$ISSUE_NUMBER" ]]; then
            echo "âš  PRì— ì—°ê²°ëœ Issueë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (Issue ì—°ë™ì´ ì—†ì„ ìˆ˜ë„ ìˆìŒ)"
            exit 0  # ê°•ì œ ì¢…ë£Œí•˜ì§€ ì•Šê³  ê²½ê³ ë§Œ ì¶œë ¥
          else
            echo "ğŸ” PRê³¼ ì—°ê²°ëœ Issue ë²ˆí˜¸: $ISSUE_NUMBER"
            echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
          fi

      - name: Find Notion Page for the Issue
        run: |
          echo "ğŸ” Searching for Notion Page with Issue Number: $ISSUE_NUMBER"

          QUERY_RESULT=$(curl -X POST "https://api.notion.com/v1/databases/${{ secrets.NOTION_DATABASE_ID }}/query" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data '{
            "filter": {
              "property": "ì´ìŠˆ ë²ˆí˜¸",
              "number": {
                "equals": '"$ISSUE_NUMBER"'
              }
            }
          }')

          page_id=$(echo "$QUERY_RESULT" | jq -r '.results[0].id')

          if [[ "$page_id" != "null" && "$page_id" != "" ]]; then
            echo "âœ… Notion Page ID ì°¾ìŒ: $page_id"
            echo "PAGE_ID=$page_id" >> $GITHUB_ENV
          else
            echo "âŒ Notion í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: Update Notion Page Status to "ë¦¬ë·° ëŒ€ê¸°"
        run: |
          curl -X PATCH "https://api.notion.com/v1/pages/${{ env.PAGE_ID }}" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data '{
            "properties": {
              "ìƒíƒœ": { "status": { "name": "ë¦¬ë·° ëŒ€ê¸°" } }
            }
          }'
